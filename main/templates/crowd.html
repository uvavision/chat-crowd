<html>
  <head>
    <base href="/">
    <title>Chat task as {{role}}</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css" rel="stylesheet">
    <link href="{{url_for('static', filename='css/materialize-tags.css')}}" rel="stylesheet">
    <link href=href="{{url_for('static', filename='css/materialize.css')}}" type="text/css" rel="stylesheet">
    <link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="{{url_for('static', filename='css/app.css')}}" rel="stylesheet">

    <script type="text/javascript" src="//code.jquery.com/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

    <script type="text/javascript" charset="utf-8">
        var socket;
        $(document).ready(function(){
            socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
            socket.on('connect', function(data) {
                socket.emit('joined', {});
            });
            socket.on('status', function(data) {
                Api.sendRequest(data.msg, data.role);
            });
            socket.on('message', function(data) {
                if (data.role != "{{role}}") {
                  $.titleAlert("ðŸ“ˆ New Message from " + data.role + '!', { requireBlur:false, stopOnFocus:true, duration:0, interval:200 });
                }
                Api.sendRequest(data.msg, data.role);
            });
            socket.on('left', function(data) {
                // Api.sendRequest(data.msg, data.role);
                socket.emit('left', {});
                // $('#scrollingChat').scrollTop($('#scrollingChat')[0].scrollHeight);
            });
            $('#textInput').keypress(function(e) {
                var code = e.keyCode || e.which;
                if (code == 13) {
                    var text = $('#textInput').val();
                    var now = new Date(Date.now());
                    var t = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
                    $('#textInput').val("");
                    socket.emit('text', {msg:text, t:t});
                }
            });
            $('#search').click(function() {
              $('#progressbar1').show();
              $("#result").empty();
            });
            $('#reset').click(function() {
              $('#progressbar1').hide();
              $("#result").empty();
            });
        });
        function end_task() {
            socket.emit('left', {}, function() {
                socket.disconnect();
                // go back to the login page
                window.location.href = "{{ url_for('main.end') }}";
            });
        }
    </script>

    <script type=text/javascript>
      $(function() {
        $('#search').bind('click', function() {
          var mbeds = [];
          $('#beds :selected').each(function(i, selected){
            mbeds[i] = $(selected).val();
          });
          $.getJSON('/_lookup', {
            price_low: $('#price_low').val(),
            price_high: $('#price_high').val(),
            baths: $('#baths').val(),
            beds: mbeds,
            neighborhood: $('#neighborhood').val(),
            borough: $('#borough').val(),
            transport: $('#transport').val(),
            amenity: $('#amenity').val()
          }, function(data) {
            $("#result").html(data.result);
            $("#rcount").html(data.count);
            $("#rcount1").html(data.count1);
            $("#more").html(data.more);
            $.ajax({
                success: function(){
                    $("#progressbar1").hide();
                    $("#pre-search").hide();
                    $("#post-search").show();
                }
            });
          });
          return false;
        });
      });
    </script>

    <!-- MTS begin -->
    <script type=text/javascript>
      $(function() {
        $('#mts_get').bind('click', function() {
          var mbeds = [];
          $('#beds :selected').each(function(i, selected){
            mbeds[i] = $(selected).val();
          });
          $.getJSON('/wizard_of_oz/mts/get', {}, function(data) {
            $("#mts_response").html(data.mts_response);
            $("#mts_price_low").html(data.price_low);
            $("#mts_price_high").html(data.price_high);
            $("#mts_beds").html(data.beds);
            $("#mts_baths").html(data.baths);
            $("#beds").html(data.beds);
            $.ajax({
                success: function(){
                    $("#progressbar1").hide();
                    $("#pre-search").hide();
                    $("#post-search").show();
                }
            });
          });
          return false;
        });
      });
    </script>
    <!-- MTS end -->
    <!-- MTS begin -->
        <script type=text/javascript>
          $(function() {
            $('#mts_post').bind('click', function() {
              var mbeds = [];
              $('#beds :selected').each(function(i, selected){
                mbeds[i] = $(selected).val();
              });
              $.getJSON('/_lookup', {
                price_low: $('#price_low').val(),
                price_high: $('#price_high').val(),
                baths: $('#baths').val(),
                beds: mbeds,
                neighborhood: $('#neighborhood').val(),
                borough: $('#borough').val(),
                transport: $('#transport').val(),
                amenity: $('#amenity').val()
              }, function(data) {
                $("#result").html(data.result);
                $("#rcount").html(data.count);
                $("#rcount1").html(data.count1);
                $("#more").html(data.more);
                $.ajax({
                    success: function(){
                        $("#progressbar1").hide();
                        $("#pre-search").hide();
                        $("#post-search").show();
                    }
                });
              });
              return false;
            });
          });
        </script>
    <!-- MTS end -->

  </head>

  <body>
    {% if role == 'agent' and mode == 'chat' %}
      <div id="view-change-button" class="button" onclick="PayloadPanel.togglePanel(event, this)">
        <img class="option full" src="{{url_for('static', filename='img/Chat Button.png')}}">
        <img class="option not-full" src="{{url_for('static', filename='img/Code Button.png')}}">
      </div>
    {% endif %}


    <div id="contentParent" class="responsive-columns-wrapper">
      {% if mode == 'chat' %}
        <div id="chat-column-holder" class="responsive-column content-column">
          {% if role == "agent" %}
            <div class="bg-header deep-purple lighten-5">
              Welcome
              <b>{{username}}</b>! You have logged in as an <b>{{role}}</b> for the task!
              <div class="purple-text">
                <b>Now chat!</b>
                <button href="#" onclick="end_task();"><b>Click here when the task is completed</b></button>
              </div>
            </div>
          {%  else %}
            <div class="bg-header blue lighten-5">
              Welcome
              <b>{{username}}</b>! You have logged in as a <b>{{role}}</b> for the task!
              <div class="blue-text">
                <b>Now chat!</b>
                <button href="#" onclick="end_task();"><b>Click here when the task is completed</b></button>
              </div>
            </div>
          {% endif %}

          <div class="chat-column">
            <div id="scrollingChat"></div>
            <div class="input-field inputOutline">
              <i class="material-icons prefix">textsms</i>
              <input id="textInput" placeholder="Type here...">
            </div>
          </div>
        </div>
      {% endif %}

<!-- MTS -->
      {% if role == 'agent' %}
      <div id="payload-column" class="fixed-column content-column">
        <div class="card-panel white lighten-5">
          <div class="row">
            <b><u>MTS Form Filling</u></b>
            <textarea id="mts_response" class="red-text"></textarea>
          </div>
          <form class="col s12" method="POST">
            <div class="row">
              <div class="input-field col s6">
                <div id="mts_price_low" class='red-text'></div>
                {{ form.price_low(class_="validate", placeholder="from: e.g., 2800") }}
                <label for="price_low">Low Price  </label>
              </div>
              <div class="input-field col s6">
                <div id="mts_price_high" class='red-text'></div>
                {{ form.price_high(class_="validate", placeholder="to: e.g., 3800")}}
                <label for="price_high">High Price</label>
              </div>
              <div class="input-field col s6">
                <div id="mts_beds" class='red-text'></div>
                {{ form.beds()}}
                <label for="beds">Number of bedrooms</label>
              </div>
              <div class="input-field col s6">
                <div id="mts_baths" class='red-text'></div>
                {{ form.baths()}}
                <label for="baths">Number of bathrooms</label>
              </div>
              <div class="col s12">
                <label for="amenity">Select the amenities (e.g.,  gym, washer)</label>
                <section id="amenity-typeahead" class="example">
                  {{ form.amenity(class_="typehead-input") }}
                </section>
              </div>
              <div class="input-field col s6">
                {{ form.borough(class_="validate", placeholder="e.g., Manhattan")}}
                <label for="borough">Select the county</label>
              </div>
              <div class="col 6">
                <label for="neighborhood">Select the neighborhood</label>
                <section id="neighborhood-typeahead" class="example">
                  {{ form.neighborhood(class_="typehead-input")}}
                </section>
              </div>
              <div class="col s12">
                <label for="transport">Select the transportation (subway and railway)</label>
                <section id="transport-typeahead" class="example">
                    {{ form.transport(class_="typehead-input")}}
                </section>
                {{ form.submit(class_="") }}
                <button id="mts_get">Get</button>
                <button id="mts_post">Post</button>
                <div class="progress" id="progressbar1">
                  <div class="indeterminate"></div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <ul class="collapsible collapsible-accordion disable-color" data-collapsible="accordion" id="pre-search">
          <li>
            <div class="collapsible-header tooltipped" data-position="top" data-delay="50"
            data-tooltip="detailed information about apartments">
               <i class="material-icons">view_list</i>Show search results
            </div>
          </li>
          <li>
            <div class="collapsible-header tooltipped" data-position="bottom" data-delay="50"
            data-tooltip="information for recommendating when there are too many/few results">
              <i class="material-icons">info_outline</i>Show more information</div>
          </li>
        </ul>
        <ul class="collapsible collapsible-accordion noshow" data-collapsible="accordion" id="post-search">
            <li>
              <div class="collapsible-header active">
                 <span class="badge" data-badge-caption="results" ></span>
                 <i class="material-icons">view_list</i></span>
                 <span class="teal-text teal-darken-2">Show search results (total: <span id="rcount"></span>)</span></div>
               <div class="collapsible-body"><div id='result'></div></div>
            </li>
            <li>
              <div class="collapsible-header">
                <span class="badge" data-badge-caption="results" id="rcount1"></span>
                <i class="material-icons">info_outline</i>
                <span class="teal-text teal-darken-2">Show more information</span></div>
              <div class="collapsible-body"><span><div id='more'></div></span></div>
            </li>
          </ul>
      </div>

      {% endif %}
<!-- MTS -->
      {% if role == 'user' %}
      <div id="payload-column" class="fixed-column content-column">
        <div class="row">
          <div class="col s12 m12">
            <div class="card ">
              <div class="card-content">
                <span class="card-title blue-text">Information about NYC</span>
              </div>
              <div class="card-action">
                <label for="neighborhood" class="blue-text">NYC neighborhood</label>
                <section id="neighborhood-typeahead" class="example">
                  <input class="typehead-input" placeholder="type here to search ..."
                  value="Williamsburg, Upper West Side, Upper East Side, Downtown Brooklyn, Tribeca, East Village, West Village, Soho, Chinatown"></input>
                </section>
              </div>
              <div class="card-action">
                <label for="transport" class="blue-text">NYC transportation</label>
                <section id="transport-typeahead" class="example">
                  <input class="typehead-input" placeholder="type here to search ..." value="4,5,6"></input>
                </section>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}


      {% if role == 'user' and mode == 'test' %}
        <div id="payload-column" class="fixed-column content-column">
          <div class="lpadding"><h5>Quiz</h5></div>
          <form class="col s12" method='POST'>
            <ol>
              <li>
                <div class="input-field row s6">
                  <div for="rental">Select all necessary information for looking for rental apartments.</div>
                  {{ form_test.rental()}}
                </div>
              </li>
              <li>
                <div class="input-field row s6">
                  <div for="neighborhood">Select all that are neighborhood in NYC.</div>
                  {{ form_test.neighborhood()}}
                </div>
              </li>
            {{ form_test.submit(class_="btn blue") }}
          </form>
        </div>
      {% endif %}

      {% if role == 'agent' and mode == 'test' %}
        <div id="payload-column" class="fixed-column content-column">
          <div class="lpadding"><h5>Quiz</h5></div>
          <form class="col s12"  method="POST">
            <ol>
              <li>
                <div class="input-field col s6">
                  {{lst_data[0][0]}}
                </div>
                <div class="input-field col s6">
                  {{ form_test.r1()}}
                  <label for="r1">search result total</label>
                </div>
              </li>
              <li>
                <div class="input-field col s6">
                  {{lst_data[1][0]}}
                </div>
                <div class="input-field col s6">
                  {{ form_test.r2()}}
                <label for="r2">search result total</label>
              </div>
              </li>
              <li>
                <div class="input-field col s6">
                  {{lst_data[2][0]}}
                </div>
                <div class="input-field col s6">
                  {{ form_test.r3()}}
                  <label for="r3">search result total</label>
                </div>
              </li>
            </ol>
            <div class="input-field col s6">
              {{ form_test.submit() }}
            </div>
          </form>
        </div>

      {% endif %}

      <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

      <script src="{{url_for('static', filename='js/common.js')}}"></script>
      <script src="{{url_for('static', filename='js/api.js')}}"></script>
      <script src="{{url_for('static', filename='js/conversation.js')}}"></script>
      <script src="{{url_for('static', filename='js/payload.js')}}"></script>
      <script src="{{url_for('static', filename='js/global.js')}}"></script>

      <script src="{{url_for('static', filename='js/jquery.titlealert.js')}}"></script>
      <script src="{{url_for('static', filename='js/clipboard.min.js')}}"></script>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.4/typeahead.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.0/clipboard.min.js"></script>
      <script src="{{url_for('static', filename='js/materialize-tags.min.js')}}"></script>
      <script src="{{url_for('static', filename='js/app.js')}}" type="text/javascript"></script>
      <script src="{{url_for('static', filename='js/init.js')}}" type="text/javascript"></script>
      <script>
        $(document).ready(function () {
            $('select').material_select();
            $('select').change(function(){
                var newValuesArr = [],
                    select = $(this),
                    ul = select.prev();
                ul.children('li').toArray().forEach(function (li, i) {
                    if ($(li).hasClass('active')) {
                        newValuesArr.push(select.children('option').toArray()[i].value);
                    }
                });
                select.val(newValuesArr);
            });
          });
      </script>

      <script>
      $.fn.timedDisable = function(time) {
       if (time == null) {
         time = 5;
       }
       var seconds = Math.ceil(time); // Calculate the number of seconds
       return $(this).each(function() {
         $(this).attr('disabled', 'disabled');
         var disabledElem = $(this);
         var originalText = this.innerHTML; // Remember the original text content

         // append the number of seconds to the text
         disabledElem.text('Please do not leave until ' + seconds + 's');

         // do a set interval, using an interval of 1000 milliseconds
         //     and clear it after the number of seconds counts down to 0
         var interval = setInterval(function() {
           seconds = seconds - 1;
           // decrement the seconds and update the text
           disabledElem.text('Please do not leave until ' + seconds + 's');
           if (seconds === 0) { // once seconds is 0...
             disabledElem.removeAttr('disabled')
               .text(originalText); //reset to original text
             clearInterval(interval); // clear interval
           }
         }, 1000);
       });
     };

     $(function() {
       $('#leave').timedDisable(120);
     });
      </script>

      <script>
        var clipboard = new Clipboard('.copy');
      </script>
  </body>
  </html>
